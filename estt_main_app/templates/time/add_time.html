{% extends 'base.html' %} {% load static %} {% block head%}
<title>ESTT - Add Time</title>

<script
  defer
  src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
></script>
{% endblock %} {% block content %}
<div class="container text-white" x-data="timeForm()" x-init="loadGames()">
  <div class="card card-dark">
    <div class="card-header card-header-gradient d-flex justify-content-between align-items-center">
      <h2 class="mb-0">New time for {{user.username}}</h2>
      <div class="header-btns-container">
        <a href="{% url 'dashboard' %}" class="header-btn">Back to Dashboard</a>
      </div>
    </div>
    <div class="card-body">
      <h3>You must choose a game in order to select a level and input your time</h3>
      <select
        class="form-select mb-3"
        name="game"
        id="games"
        @change="loadLevels($event.target.value)"
      >
        <option value="" disabled selected>Select a game</option>
        <template x-for="game in games" :key="game.id">
          <option :value="game.id" x-text="game.game"></option>
        </template>
      </select>

      <!-- Level and Time Form -->
      <form
        class="mt-3"
        method="post"
        x-show="levels.length > 0"
        @submit.prevent="submitForm"
      >
        {% csrf_token %}
        <div class="mb-3">
          <select class="form-select" name="level" required>
            <option value="" disabled selected>Select a level</option>
            <template x-for="level in levels" :key="level.id">
              <option :value="level.id" x-text="level.level_name"></option>
            </template>
          </select>
        </div>
        <div class="mb-3">
          <input
            type="text"
            class="form-control"
            name="time"
            placeholder="Enter time (e.g., 00:00.00)"
            required
          />
        </div>
        <div class="d-flex gap-2">
          <button type="submit" class="btn btn-primary">Add Time</button>
          <a href="{% url 'dashboard' %}" class="btn btn-secondary">Nevermind</a>
        </div>
      </form>

      <!-- Cancel Button (Visible when no game selected) -->
      <div class="mt-3" x-show="levels.length === 0">
        <a href="{% url 'dashboard' %}" class="btn btn-secondary">Nevermind</a>
      </div>

      <!-- Error Message -->
      <p x-show="errorMessage" style="color: red;" x-text="errorMessage"></p>
    </div>
  </div>
</div>

<script>
  function timeForm() {
    return {
      games: [],
      levels: [],
      errorMessage: "",
      async loadGames() {
        try {
          const response = await fetch("/api/new-time-get-games/");
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.errors || "Failed to fetch games.");
          }
          const data = await response.json();
          if (data.success) {
            this.games = data.games;
          } else {
            throw new Error(data.errors || "Failed to fetch games.");
          }
        } catch (error) {
          this.errorMessage = error.message;
          console.error("Error loading games:", error);
        }
      },
      async loadLevels(gameId) {
        if (!gameId) {
          this.errorMessage = "Please select a game.";
          return;
        }
        try {
          const response = await fetch(`/api/get-levels/?game_id=${gameId}`);
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.errors || "Failed to fetch levels.");
          }
          const data = await response.json();
          if (data.success) {
            this.levels = data.levels;
            this.errorMessage = "";
          } else {
            throw new Error(data.errors || "Failed to fetch levels.");
          }
        } catch (error) {
          this.errorMessage = error.message;
          console.error("Error loading levels:", error);
        }
      },
      async submitForm() {
        const levelValue = document.querySelector('select[name="level"]').value;
        const timeValue = document.querySelector('input[name="time"]').value;

        const formData = new FormData(document.querySelector("form"));
        const gameId = document.querySelector("#games").value;
        formData.append("game", gameId);
        formData.append("level", levelValue);
        formData.append("time", timeValue);

        try {
          const response = await fetch("/add-time/", {
            method: "POST",
            body: formData,
          });

          const result = await response.json();
          if (response.ok && result.success) {
            this.showConfirmation();
          } else {
            this.errorMessage = result.errors || "An unexpected error occurred.";
          }
        } catch (error) {
          this.errorMessage = "Failed to submit the form. Please try again.";
          console.error("Error submitting form:", error);
        }
      },
      showConfirmation() {
        if (confirm("Time saved successfully! Would you like to add another?")) {
          document.querySelector("form").reset();
          this.levels = [];
        } else {
          window.location.href = "/dashboard/";
        }
      },
    };
  }
</script>

{% endblock %}
